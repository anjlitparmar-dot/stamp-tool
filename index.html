<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gujarat Stamp Act Tool</title>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Vadodara:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        /* àª®à«àª³ àª«àª¾àªˆàª² àª®à«àªœàª¬àª¨à«€ àª¤àª®àª¾àª® àª¡àª¿àªàª¾àª‡àª¨ */
        :root { --primary: #2c3e50; --secondary: #1abc9c; --bg: #f8f9fa; --accent: #3498db; --text: #2c3e50; --card-bg: #ffffff; }
        * { box-sizing: border-box; font-family: 'Hind Vadodara', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); }

        .home-screen { display: flex; justify-content: center; align-items: center; height: 100vh; gap: 20px; background: linear-gradient(135deg, #2c3e50 0%, #1a252f 100%); flex-direction: column; text-align: center; color: white; }
        .tiles-container { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }
        .main-tile { width: 200px; height: 160px; background: white; border-radius: 20px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 10px 30px rgba(0,0,0,0.3); color: #2c3e50; transition: 0.3s; }
        .main-tile:hover { transform: translateY(-5px); background: #f0fffb; }

        #app-view { display: none; height: 100vh; flex-direction: row; }
        .sidebar { width: 320px; background: var(--primary); color: white; display: flex; flex-direction: column; }
        .sidebar-list { flex-grow: 1; overflow-y: auto; list-style: none; padding: 10px; margin: 0; }
        .sidebar-list li { padding: 10px; border-bottom: 1px solid #34495e; cursor: pointer; border-radius: 5px; font-size: 14px; display: flex; justify-content: space-between; align-items: center; }
        .sidebar-list li.active { background: var(--secondary); font-weight: 600; }

        .main-content { flex: 1; overflow-y: auto; padding: 20px; }
        .top-nav { background: var(--card-bg); padding: 15px; border-radius: 12px; margin-bottom: 20px; display: flex; gap: 10px; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        .card { background: var(--card-bg); border-radius: 12px; border: 1px solid rgba(0,0,0,0.1); margin-bottom: 15px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .cat-header { background: #f1f4f7; padding: 10px 15px; font-weight: 600; border-left: 5px solid var(--secondary); color: var(--primary); }
        
        table { width: 100%; border-collapse: collapse; }
        td { padding: 12px; border-bottom: 1px solid rgba(0,0,0,0.05); font-size: 14px; color: var(--text); }
        
        .btn { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-rename { background: #ebf5fb; color: var(--accent); font-size: 12px; padding: 4px 8px; border-radius: 4px; border: 1px solid var(--accent); margin-left: 10px; }
        .btn-del { color: #e74c3c; background: none; font-size: 16px; border: none; }

        .search-box { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 10px; }
        .lang-btn { background: #f39c12; color: white; }

        @media print { .sidebar, .top-nav, .add-section, .btn-del, .btn-rename, .no-print { display: none !important; } }
    </style>
</head>
<body>

    <div id="home-view" class="home-screen">
        <h1 id="home-title">àª—à«àªœàª°àª¾àª¤ àª¸à«àªŸà«‡àª®à«àªª àª…àª§àª¿àª¨àª¿àª¯àª®-à«§à«¯à««à«®</h1>
        <div style="margin-bottom:15px;">
            <button id="auth_btn" class="btn" style="background:#4285F4; color:white;" onclick="handleAuthClick()">ğŸ” Google Drive àª¸àª¾àª¥à«‡ àªœà«‹àª¡à«‹</button>
        </div>
        <div class="tiles-container">
            <div class="main-tile" onclick="openModule('àª•àª²àª®')"><h2 id="tile-section">ğŸ“œ àª•àª²àª®</h2></div>
            <div class="main-tile" onclick="openModule('àª†àª°à«àªŸà«€àª•àª²')"><h2 id="tile-article">ğŸ“‘ àª†àª°à«àªŸà«€àª•àª²</h2></div>
            <div class="main-tile" onclick="openModule('àªœàª‚àª¤à«àª°à«€')"><h2 id="tile-jantri">ğŸ—ºï¸ àªœàª‚àª¤à«àª°à«€</h2></div>
        </div>
        <div style="margin-top: 25px; display: flex; gap: 15px;">
            <button class="btn lang-btn" onclick="toggleLang()">ğŸŒ English / àª—à«àªœàª°àª¾àª¤à«€</button>
            <button class="btn" style="background:rgba(255,255,255,0.2); color:white" onclick="exportData()">ğŸ’¾ àª¬à«‡àª•àª…àªª</button>
            <button class="btn" style="background:rgba(255,255,255,0.2); color:white" onclick="document.getElementById('importFile').click()">ğŸ“‚ àª°à«€àª¸à«àªŸà«‹àª°</button>
            <input type="file" id="importFile" style="display:none" onchange="importData(event)">
        </div>
    </div>

    <div id="app-view">
        <div class="sidebar">
            <div style="padding:15px;"><button class="btn" id="btn-home" style="background:#e74c3c; color:white; width:100%" onclick="goHome()">â† àª®à«àª–à«àª¯ àª®à«‡àª¨à«</button></div>
            <div style="padding: 0 15px 10px 15px;">
                <input type="text" id="sideSearch" class="search-box" oninput="refreshSide()">
            </div>
            <ul id="item-list" class="sidebar-list"></ul>
        </div>

        <div class="main-content">
            <div class="top-nav">
                <div style="flex:1; display:flex; align-items:center;">
                    <h2 id="current-name" style="margin:0;">àªªàª¸àª‚àª¦ àª•àª°à«‹</h2>
                    <span id="rename-container"></span>
                </div>
                <button class="btn" id="fav-btn" onclick="toggleFav()" style="margin-right:10px;">â­</button>
                <button class="btn lang-btn" onclick="toggleLang()">ğŸŒ Language</button>
                <button class="btn no-print" style="background:var(--primary); color:white; margin-left:10px;" onclick="window.print()">ğŸ–¨ï¸ àªªà«àª°àª¿àª¨à«àªŸ</button>
            </div>

            <div class="card" style="padding: 20px; background: #fffdf0;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <strong id="label-provision">ğŸ“– àª•àª¾àª¯àª¦àª¾àª•à«€àª¯ àªœà«‹àª—àªµàª¾àªˆ:</strong>
                    <button class="btn no-print" onclick="editP()" id="p-edit-btn" style="background:#eee">âœï¸ àª¸à«àª§àª¾àª°à«‹</button>
                </div>
                <div id="p-text" style="white-space:pre-wrap; margin-top:10px; line-height:1.6;">àª®àª¾àª¹àª¿àª¤à«€ àª­àª°à«‹...</div>
                <textarea id="p-input" style="width:100%; height:150px; display:none; margin-top:10px; padding:10px; border-radius:8px;"></textarea>
                <button id="p-save" class="btn" style="display:none; margin-top:10px; background:var(--secondary); color:white" onclick="saveP()">àª¸à«‡àªµ àª•àª°à«‹</button>
            </div>

            <div class="card add-section" style="padding:15px;">
                <div style="display:flex; gap:10px; flex-wrap: wrap; align-items:center;">
                    <input type="text" id="fName" style="flex:2; padding:8px; border-radius:5px; border:1px solid #ddd;">
                    <input type="date" id="fDate" style="padding:8px; border-radius:5px; border:1px solid #ddd;">
                    
                    <div style="display:flex; flex-direction:column; gap:2px;">
                        <input type="file" id="fPDFFile" accept="application/pdf" style="font-size:12px; width:150px;">
                        <small id="upload-status" style="color:orange; font-size:10px;"></small>
                    </div>

                    <select id="fType" style="padding:8px; border-radius:5px; border:1px solid #ddd;">
                        <option>CCRA àª¹à«àª•àª®</option><option>àªªàª°àª¿àªªàª¤à«àª°</option><option>àª àª°àª¾àªµ</option>
                        <option>àª“àª¡à«€àªŸ àªªà«‡àª°àª¾</option><option>àª•à«‹àª°à«àªŸàª¨àª¾ àªšà«àª•àª¾àª¦àª¾</option>
                    </select>
                    <button class="btn" style="background:var(--secondary); color:white" id="btn-add" onclick="addFileWithUpload()">â• àª‰àª®à«‡àª°à«‹</button>
                </div>
            </div>
            <div id="results-area"></div>
        </div>
    </div>

    <script>
        // Google Config
        const CLIENT_ID = '397668795740-8q3rsm03at45tga2p820pi2pmris2pvu.apps.googleusercontent.com
'; 
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';

        let tokenClient, gapiInited = false;
        let curMod = ''; let curItem = ''; 
        let lang = localStorage.getItem('StampLang') || 'gu';
        let db = JSON.parse(localStorage.getItem('StampAct_V22')) || null;

        const uiText = {
            gu: { homeTitle: "àª—à«àªœàª°àª¾àª¤ àª¸à«àªŸà«‡àª®à«àªª àª…àª§àª¿àª¨àª¿àª¯àª®-à«§à«¯à««à«®", tileSection: "ğŸ“œ àª•àª²àª®", tileArticle: "ğŸ“‘ àª†àª°à«àªŸà«€àª•àª²", tileJantri: "ğŸ—ºï¸ àªœàª‚àª¤à«àª°à«€", backup: "ğŸ’¾ àª¬à«‡àª•àª…àªª", restore: "ğŸ“‚ àª°à«€àª¸à«àªŸà«‹àª°", homeBtn: "â† àª®à«àª–à«àª¯ àª®à«‡àª¨à«", search: "àª¶à«‹àª§à«‹...", print: "ğŸ–¨ï¸ àªªà«àª°àª¿àª¨à«àªŸ", provision: "ğŸ“– àª•àª¾àª¯àª¦àª¾àª•à«€àª¯ àªœà«‹àª—àªµàª¾àªˆ:", edit: "âœï¸ àª¸à«àª§àª¾àª°à«‹", save: "àª¸à«‡àªµ àª•àª°à«‹", add: "â• àª‰àª®à«‡àª°à«‹", placeholder: "àªµàª¿àª—àª¤ àª²àª–à«‹", rename: "âœï¸ àª¨àª¾àª® àª†àªªà«‹", locked: "ğŸ”’ Locked" },
            en: { homeTitle: "Gujarat Stamp Act-1958", tileSection: "ğŸ“œ Sections", tileArticle: "ğŸ“‘ Articles", tileJantri: "ğŸ—ºï¸ Jantri", backup: "ğŸ’¾ Backup", restore: "ğŸ“‚ Restore", homeBtn: "â† Main Menu", search: "Search...", print: "ğŸ–¨ï¸ Print", provision: "ğŸ“– Legal Provision:", edit: "âœï¸ Edit", save: "Save", add: "â• Add", placeholder: "Enter details", rename: "âœï¸ Rename", locked: "ğŸ”’ Locked" }
        };

        // Google Auth
        function gapiLoaded() { gapi.load('client', async () => { await gapi.client.init({ discoveryDocs: [DISCOVERY_DOC] }); gapiInited = true; }); }
        function gisLoaded() { tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: '' }); }
        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) throw (resp);
                document.getElementById('auth_btn').innerText = "âœ… àª¸àª¿àª‚àª• àªšàª¾àª²à« àª›à«‡";
                document.getElementById('auth_btn').style.background = "#27ae60";
            };
            tokenClient.requestAccessToken({prompt: 'consent'});
        }

        if (!db) {
            db = {"àª•àª²àª®":{}, "àª†àª°à«àªŸà«€àª•àª²":{}, "àªœàª‚àª¤à«àª°à«€":{}};
            for(let i=1; i<=76; i++) db["àª•àª²àª®"][`àª•àª²àª®-${i}`] = { provision: "", files: [], fav: false, isLocked: false };
            for(let i=1; i<=59; i++) db["àª†àª°à«àªŸà«€àª•àª²"][`àª†àª°à«àªŸà«€àª•àª²-${i}`] = { provision: "", files: [], fav: false, isLocked: false };
            db["àªœàª‚àª¤à«àª°à«€"]["àª®à«àª–à«àª¯ àªœàª‚àª¤à«àª°à«€"] = { provision: "", files: [], fav: false, isLocked: false };
            save();
        }

        function save() { localStorage.setItem('StampAct_V22', JSON.stringify(db)); }
        function toggleLang() { lang = lang === 'gu' ? 'en' : 'gu'; localStorage.setItem('StampLang', lang); applyLang(); refreshSide(); }

        function applyLang() {
            const t = uiText[lang];
            document.getElementById('home-title').innerText = t.homeTitle;
            document.getElementById('tile-section').innerText = t.tileSection;
            document.getElementById('tile-article').innerText = t.tileArticle;
            document.getElementById('tile-jantri').innerText = t.tileJantri;
            document.getElementById('btn-home').innerText = t.homeBtn;
            document.getElementById('sideSearch').placeholder = t.search;
            document.getElementById('label-provision').innerText = t.provision;
            document.getElementById('p-edit-btn').innerText = t.edit;
            document.getElementById('p-save').innerText = t.save;
            document.getElementById('btn-add').innerText = t.add;
            document.getElementById('fName').placeholder = t.placeholder;
        }

        function openModule(m) {
            curMod = m; document.getElementById('home-view').style.display='none';
            document.getElementById('app-view').style.display='flex';
            applyLang(); refreshSide(); selectItem(Object.keys(db[curMod])[0]);
        }
        function goHome() { document.getElementById('home-view').style.display='flex'; document.getElementById('app-view').style.display='none'; }

        function refreshSide() {
            const list = document.getElementById('item-list'); 
            const search = document.getElementById('sideSearch').value.toLowerCase();
            list.innerHTML = "";
            let keys = Object.keys(db[curMod]).sort((a,b) => (db[curMod][b].fav - db[curMod][a].fav));
            keys.forEach(k => {
                if(k.toLowerCase().includes(search)) {
                    const li = document.createElement('li'); 
                    li.innerHTML = `<span>${db[curMod][k].fav ? 'â­ ' : ''}${k}</span>`;
                    li.onclick = () => selectItem(k); 
                    if(k === curItem) li.className = 'active';
                    list.appendChild(li);
                }
            });
        }

        function selectItem(n) {
            curItem = n; 
            document.getElementById('current-name').innerText = n;
            const renBtn = document.getElementById('rename-container');
            if(!db[curMod][curItem].isLocked) {
                renBtn.innerHTML = `<button class="btn-rename no-print" onclick="renameItem()">${uiText[lang].rename}</button>`;
            } else {
                renBtn.innerHTML = `<span style="font-size:12px; color:#999; margin-left:10px;">${uiText[lang].locked}</span>`;
            }
            document.getElementById('fav-btn').style.color = db[curMod][curItem].fav ? "#f1c40f" : "#ccc";
            document.getElementById('p-text').innerText = db[curMod][curItem].provision || "...";
            renderFiles(); refreshSide();
        }

        async function addFileWithUpload() {
            const name = document.getElementById('fName').value;
            const date = document.getElementById('fDate').value;
            const type = document.getElementById('fType').value;
            const fileInput = document.getElementById('fPDFFile');
            const status = document.getElementById('upload-status');

            if(!name || fileInput.files.length === 0) return alert("àª¨àª¾àª® àª…àª¨à«‡ àª«àª¾àª‡àª² àªœàª°à«‚àª°à«€ àª›à«‡!");
            
            status.innerText = "â³ àª…àªªàª²à«‹àª¡ àªšàª¾àª²à« àª›à«‡...";
            try {
                const file = fileInput.files[0];
                const metadata = { 'name': file.name, 'mimeType': 'application/pdf' };
                const formData = new FormData();
                formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                formData.append('file', file);

                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webViewLink', {
                    method: 'POST',
                    headers: new Headers({ 'Authorization': 'Bearer ' + gapi.client.getToken().access_token }),
                    body: formData
                });
                const result = await response.json();
                
                db[curMod][curItem].files.push({ id: Date.now(), name, date, url: result.webViewLink, type, ts: new Date(date).getTime() });
                save(); renderFiles();
                
                status.innerText = "âœ… àª¸à«‡àªµ àª¥àª¯à«àª‚!";
                document.getElementById('fName').value = ''; fileInput.value = '';
                setTimeout(() => status.innerText = "", 2000);
            } catch (err) {
                status.innerText = "âŒ àª­à«‚àª²!";
                alert("àªªàª¹à«‡àª²àª¾ 'Google Drive àª¸àª¾àª¥à«‡ àªœà«‹àª¡à«‹' àªªàª° àª•à«àª²àª¿àª• àª•àª°à«‹.");
            }
        }

        function renderFiles() {
            const container = document.getElementById('results-area'); container.innerHTML = "";
            const cats = ["CCRA àª¹à«àª•àª®", "àªªàª°àª¿àªªàª¤à«àª°", "àª àª°àª¾àªµ", "àª“àª¡à«€àªŸ àªªà«‡àª°àª¾", "àª•à«‹àª°à«àªŸàª¨àª¾ àªšà«àª•àª¾àª¦àª¾"];
            cats.forEach(c => {
                let filtered = db[curMod][curItem].files.filter(f => f.type === c).sort((a,b) => b.ts - a.ts);
                if(filtered.length > 0) {
                    let h = `<div class="card"><div class="cat-header">${c}</div><table>`;
                    filtered.forEach(f => {
                        h += `<tr><td width="100">${f.date ? f.date.split('-').reverse().join('-') : '--'}</td>
                        <td><a href="${f.url}" target="_blank" style="text-decoration:none; color:var(--accent); font-weight:600;">ğŸ“„ ${f.name}</a></td>
                        <td width="50" class="no-print"><button class="btn-del" onclick="deleteFile(${f.id})">ğŸ—‘ï¸</button></td></tr>`;
                    });
                    container.innerHTML += h + `</table></div>`;
                }
            });
        }

        // àª¬àª¾àª•à«€àª¨àª¾ àª®à«àª³ àª«àª‚àª•à«àª¶àª¨
        function renameItem() { let msg = lang === 'gu' ? "àª¨àªµà«àª‚ àª¨àª¾àª®:" : "New name:"; let newT = prompt(msg, curItem); if(newT) { db[curMod][newT] = db[curMod][curItem]; db[curMod][newT].isLocked=true; delete db[curMod][curItem]; curItem=newT; save(); refreshSide(); selectItem(newT); } }
        function toggleFav() { db[curMod][curItem].fav = !db[curMod][curItem].fav; save(); selectItem(curItem); }
        function editP() { document.getElementById('p-text').style.display='none'; document.getElementById('p-input').style.display='block'; document.getElementById('p-input').value = db[curMod][curItem].provision; document.getElementById('p-save').style.display='block'; document.getElementById('p-edit-btn').style.display='none'; }
        function saveP() { db[curMod][curItem].provision = document.getElementById('p-input').value; save(); document.getElementById('p-text').innerText = db[curMod][curItem].provision; document.getElementById('p-text').style.display='block'; document.getElementById('p-input').style.display='none'; document.getElementById('p-save').style.display='none'; document.getElementById('p-edit-btn').style.display='block'; }
        function deleteFile(fid) { if(!confirm("Delete?")) return; db[curMod][curItem].files = db[curMod][curItem].files.filter(f => f.id !== fid); save(); renderFiles(); }
        function exportData() { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db)); const dl = document.createElement('a'); dl.setAttribute("href", dataStr); dl.setAttribute("download", "StampAct_Backup.json"); dl.click(); }
        function importData(e) { const reader = new FileReader(); reader.onload = (ev) => { db = JSON.parse(ev.target.result); save(); location.reload(); }; reader.readAsText(e.target.files[0]); }

        window.onload = () => { applyLang(); gapiLoaded(); gisLoaded(); };
    </script>
</body>
</html>
