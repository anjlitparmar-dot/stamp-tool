<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stamp Act Tool - PDF & Cloud Sync</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        :root { --primary: #2c3e50; --secondary: #1abc9c; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: var(--bg); }
        .container { padding: 20px; max-width: 1000px; margin: auto; }
        .header { background: var(--primary); color: white; padding: 20px; text-align: center; border-radius: 0 0 20px 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-top: 20px; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-google { background: #4285F4; color: white; }
        .btn-save { background: var(--secondary); color: white; }
        #status { margin-top: 10px; font-size: 14px; color: #666; }
        .file-input { margin: 20px 0; padding: 10px; border: 2px dashed #ddd; width: 100%; text-align: center; }
    </style>
</head>
<body>

<div class="header">
    <h1>ЁЯУЬ ркЧрлБркЬрк░рк╛ркд рк╕рлНркЯрлЗркорлНркк ркЕркзрк┐ркирк┐ркпрко ркЯрлВрк▓</h1>
    <button id="auth_button" class="btn btn-google" onclick="handleAuthClick()">ЁЯФР Google Drive рк╕рк╛ркерлЗ ркЬрлЛркбрлЛ</button>
    <p id="status">рк╕рлНркерк┐ркдрк┐: ркбрк┐рк╕рлНркХркирлЗркХрлНркЯрлЗркб</p>
</div>

<div class="container">
    <div class="card">
        <h3>ЁЯУВ PDF рклрк╛ркИрк▓ ркЕрккрк▓рлЛркб ркХрк░рлЛ</h3>
        <p style="font-size: 12px; color: red;">* ркЖ рклрк╛ркИрк▓рлЛ рк╕рлАркзрлА ркдркорк╛рк░рк╛ ркЧрлВркЧрк▓ ркбрлНрк░рк╛ркИрк╡ркорк╛ркВ рк╕рлЗрк╡ ркерк╢рлЗ.</p>
        <input type="file" id="pdf-upload" class="file-input" accept="application/pdf" multiple>
        <button class="btn btn-save" onclick="uploadFiles()">ЁЯЪА ркбрлНрк░рк╛ркИрк╡ рккрк░ ркЕрккрк▓рлЛркб ркХрк░рлЛ</button>
    </div>

    <div class="card">
        <h3>ЁЯУЭ ркбрлЗркЯрк╛ ркПркирлНркЯрлНрк░рлА</h3>
        <textarea id="data-text" style="width:100%; height:100px; padding:10px;" placeholder="ркЕрк╣рлАркВ рк╡рк┐ркЧркдрлЛ рк▓ркЦрлЛ..."></textarea>
        <br><br>
        <button class="btn btn-save" onclick="saveData()">ЁЯТ╛ ркбрлЗркЯрк╛ рк╕рлЗрк╡ ркХрк░рлЛ</button>
    </div>
</div>

<script>
    const CLIENT_ID = '397668795740-8q3rsm03at45tga2p820pi2pmris2pvu.apps.googleusercontent.com
'; 
    const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
    // SCOPES ркорк╛ркВ drive.file ркЙркорлЗрк░рлНркпрлБркВ ркЫрлЗ ркЬрлЗркерлА PDF рк╕рлЗрк╡ ркеркИ рк╢ркХрлЗ
    const SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.appdata';

    let tokenClient;
    let gapiInited = false;

    // 1. Initialize Google API
    function gapiLoaded() {
        gapi.load('client', async () => {
            await gapi.client.init({ discoveryDocs: [DISCOVERY_DOC] });
            gapiInited = true;
        });
    }

    function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            callback: '', 
        });
    }

    // 2. Authentication
    async function handleAuthClick() {
        tokenClient.callback = async (resp) => {
            if (resp.error !== undefined) throw (resp);
            document.getElementById('status').innerText = "тЬЕ ркЧрлВркЧрк▓ ркбрлНрк░рк╛ркИрк╡ рк╕рк╛ркерлЗ ркЬрлЛркбрк╛ркпрлЗрк▓ ркЫрлЗ";
            document.getElementById('auth_button').style.display = 'none';
        };
        tokenClient.requestAccessToken({prompt: 'consent'});
    }

    // 3. PDF Upload Function
    async function uploadFiles() {
        const fileInput = document.getElementById('pdf-upload');
        if (fileInput.files.length === 0) {
            alert("ркорк╣рлЗрк░ркмрк╛ркирлА ркХрк░рлАркирлЗ ркПркХ PDF рклрк╛ркИрк▓ рккрк╕ркВркж ркХрк░рлЛ.");
            return;
        }

        document.getElementById('status').innerText = "тП│ ркЕрккрк▓рлЛркб ркеркИ рк░рк╣рлНркпрлБркВ ркЫрлЗ...";

        for (let file of fileInput.files) {
            const metadata = {
                'name': file.name,
                'mimeType': 'application/pdf'
            };

            const formData = new FormData();
            formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            formData.append('file', file);

            try {
                await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: new Headers({ 'Authorization': 'Bearer ' + gapi.client.getToken().access_token }),
                    body: formData
                });
            } catch (err) {
                console.error("Upload error:", err);
            }
        }
        document.getElementById('status').innerText = "тЬЕ ркмркзрлА PDF рк╕рклрк│ркдрк╛рккрлВрк░рлНрк╡ркХ ркЕрккрк▓рлЛркб ркеркИ ркЧркИ!";
        alert("рклрк╛ркИрк▓рлЛ ркбрлНрк░рк╛ркИрк╡ркорк╛ркВ рк╕рлЗрк╡ ркеркИ ркЧркИ ркЫрлЗ.");
    }

    // 4. Save Text Data to AppData
    async function saveData() {
        const text = document.getElementById('data-text').value;
        const fileName = 'stamp_data.json';
        const content = JSON.stringify({ detail: text, date: new Date() });

        const metadata = {
            'name': fileName,
            'mimeType': 'application/json',
            'parents': ['appDataFolder']
        };

        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        form.append('file', new Blob([content], { type: 'application/json' }));

        await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
            method: 'POST',
            headers: new Headers({ 'Authorization': 'Bearer ' + gapi.client.getToken().access_token }),
            body: form
        });
        alert("ркбрлЗркЯрк╛ рк╕рлЗрк╡ ркеркпрлЛ!");
    }

    window.onload = () => { gapiLoaded(); gisLoaded(); };
</script>

<script src="https://accounts.google.com/gsi/client" onload="gisLoaded()" async defer></script>
</body>
</html>
