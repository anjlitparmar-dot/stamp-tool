<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gujarat Stamp Act Tool - Synced</title>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Vadodara:wght@400;600&display=swap" rel="stylesheet">
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>

    <style>
        :root { --primary: #2c3e50; --secondary: #1abc9c; --bg: #f8f9fa; --accent: #3498db; --text: #2c3e50; --card-bg: #ffffff; }
        * { box-sizing: border-box; font-family: 'Hind Vadodara', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); }

        .home-screen { display: flex; justify-content: center; align-items: center; height: 100vh; gap: 20px; background: linear-gradient(135deg, #2c3e50 0%, #1a252f 100%); flex-direction: column; text-align: center; color: white; }
        .tiles-container { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }
        .main-tile { width: 200px; height: 160px; background: white; border-radius: 20px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 10px 30px rgba(0,0,0,0.3); color: #2c3e50; transition: 0.3s; }
        
        #app-view { display: none; height: 100vh; flex-direction: row; }
        .sidebar { width: 320px; background: var(--primary); color: white; display: flex; flex-direction: column; }
        .sidebar-list { flex-grow: 1; overflow-y: auto; list-style: none; padding: 10px; margin: 0; }
        .sidebar-list li { padding: 10px; border-bottom: 1px solid #34495e; cursor: pointer; border-radius: 5px; font-size: 14px; }
        .sidebar-list li.active { background: var(--secondary); font-weight: 600; }

        .main-content { flex: 1; overflow-y: auto; padding: 20px; }
        .top-nav { background: var(--card-bg); padding: 15px; border-radius: 12px; margin-bottom: 20px; display: flex; gap: 10px; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        .card { background: var(--card-bg); border-radius: 12px; border: 1px solid rgba(0,0,0,0.1); margin-bottom: 15px; padding: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .cat-header { background: #f1f4f7; padding: 10px 15px; font-weight: 600; border-left: 5px solid var(--secondary); margin: -15px -15px 10px -15px; }
        
        table { width: 100%; border-collapse: collapse; }
        td { padding: 12px; border-bottom: 1px solid rgba(0,0,0,0.05); }
        
        .btn { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .search-box { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="home-view" class="home-screen">
        <h1>àª—à«àªœàª°àª¾àª¤ àª¸à«àªŸà«‡àª®à«àªª àª…àª§àª¿àª¨àª¿àª¯àª® àªŸà«‚àª²</h1>
        <button id="auth_btn" class="btn" style="background:#4285F4; color:white; margin-bottom:20px;" onclick="handleAuthClick()">ğŸ” Google Drive àª¸àª¾àª¥à«‡ àªœà«‹àª¡à«‹</button>
        <p id="status-text" style="font-size: 12px; opacity: 0.8;">àª¸à«àª¥àª¿àª¤àª¿: àª¡àª¿àª¸à«àª•àª¨à«‡àª•à«àªŸà«‡àª¡</p>

        <div class="tiles-container">
            <div class="main-tile" onclick="openModule('àª•àª²àª®')"><h2>ğŸ“œ àª•àª²àª®</h2></div>
            <div class="main-tile" onclick="openModule('àª†àª°à«àªŸà«€àª•àª²')"><h2>ğŸ“‘ àª†àª°à«àªŸà«€àª•àª²</h2></div>
            <div class="main-tile" onclick="openModule('àªœàª‚àª¤à«àª°à«€')"><h2>ğŸ—ºï¸ àªœàª‚àª¤à«àª°à«€</h2></div>
        </div>
    </div>

    <div id="app-view">
        <div class="sidebar">
            <div style="padding:15px;"><button class="btn" style="background:#e74c3c; color:white; width:100%" onclick="goHome()">â† àª®à«àª–à«àª¯ àª®à«‡àª¨à«</button></div>
            <div style="padding: 0 15px 10px 15px;"><input type="text" id="sideSearch" class="search-box" placeholder="àª¶à«‹àª§à«‹..." oninput="refreshSide()"></div>
            <ul id="item-list" class="sidebar-list"></ul>
        </div>

        <div class="main-content">
            <div class="top-nav">
                <h2 id="current-name" style="flex:1; margin:0;">àªªàª¸àª‚àª¦ àª•àª°à«‹</h2>
                <button class="btn" id="fav-btn" onclick="toggleFav()">â­</button>
                <button class="btn" style="background:#f39c12; color:white" onclick="toggleLang()">ğŸŒ Language</button>
            </div>

            <div class="card" style="background: #fffdf0;">
                <div style="display:flex; justify-content:space-between;">
                    <strong>ğŸ“– àª•àª¾àª¯àª¦àª¾àª•à«€àª¯ àªœà«‹àª—àªµàª¾àªˆ:</strong>
                    <button class="btn" onclick="editP()" id="p-edit-btn">âœï¸ àª¸à«àª§àª¾àª°à«‹</button>
                </div>
                <div id="p-text" style="white-space:pre-wrap; margin-top:10px;">àª®àª¾àª¹àª¿àª¤à«€ àª­àª°à«‹...</div>
                <textarea id="p-input" style="width:100%; height:100px; display:none; margin-top:10px;"></textarea>
                <button id="p-save" class="btn" style="display:none; background:var(--secondary); color:white; margin-top:10px;" onclick="saveP()">àª¸à«‡àªµ àª•àª°à«‹</button>
            </div>

            <div class="card">
                <div style="display:flex; gap:10px; flex-wrap: wrap; align-items: center;">
                    <input type="text" id="fName" placeholder="àªµàª¿àª—àª¤ àª²àª–à«‹" style="flex:1; padding:8px;">
                    <input type="date" id="fDate" style="padding:8px;">
                    <div style="flex:1; border:1px solid #ddd; padding:5px; border-radius:5px; background:white;">
                        <span style="font-size:10px; color:gray;">PDF àª…àªªàª²à«‹àª¡ àª•àª°à«‹:</span>
                        <input type="file" id="fPDFFile" accept="application/pdf" style="font-size:12px;">
                    </div>
                    <select id="fType" style="padding:8px;">
                        <option>CCRA àª¹à«àª•àª®</option><option>àªªàª°àª¿àªªàª¤à«àª°</option><option>àª àª°àª¾àªµ</option>
                    </select>
                    <button class="btn" style="background:var(--secondary); color:white" onclick="addFileWithUpload()">â• àª‰àª®à«‡àª°à«‹</button>
                </div>
                <small id="upload-msg" style="color:blue;"></small>
            </div>
            <div id="results-area"></div>
        </div>
    </div>

    <script>
        // àª¤àª®àª¾àª°à«€ àª¸àª¾àªšà«€ Client ID
        const CLIENT_ID = '397668795740-8q3rsm03at45tga2p820pi2pmris2pvu.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';

        let tokenClient, gapiInited = false;
        let curMod = '', curItem = '';
        let db = JSON.parse(localStorage.getItem('StampAct_V22')) || {"àª•àª²àª®":{}, "àª†àª°à«àªŸà«€àª•àª²":{}, "àªœàª‚àª¤à«àª°à«€":{}};

        // Initialize Google APIs
        function gapiLoaded() { gapi.load('client', async () => { await gapi.client.init({ discoveryDocs: [DISCOVERY_DOC] }); gapiInited = true; }); }
        function gisLoaded() { tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: '' }); }

        async function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error) return;
                document.getElementById('status-text').innerText = "àª¸à«àª¥àª¿àª¤àª¿: àª•àª¨à«‡àª•à«àªŸà«‡àª¡ âœ…";
                document.getElementById('auth_btn').style.display = 'none';
            };
            tokenClient.requestAccessToken({prompt: 'consent'});
        }

        async function addFileWithUpload() {
            const fileInput = document.getElementById('fPDFFile');
            const name = document.getElementById('fName').value;
            const date = document.getElementById('fDate').value;
            const type = document.getElementById('fType').value;

            if (!fileInput.files[0] || !name) return alert("àª¨àª¾àª® àª…àª¨à«‡ àª«àª¾àª‡àª² àªœàª°à«‚àª°à«€ àª›à«‡!");
            
            document.getElementById('upload-msg').innerText = "â³ àª…àªªàª²à«‹àª¡ àª¥àªˆ àª°àª¹à«àª¯à«àª‚ àª›à«‡...";
            
            try {
                const file = fileInput.files[0];
                const metadata = { 'name': file.name, 'mimeType': 'application/pdf' };
                const formData = new FormData();
                formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                formData.append('file', file);

                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webViewLink', {
                    method: 'POST',
                    headers: new Headers({ 'Authorization': 'Bearer ' + gapi.client.getToken().access_token }),
                    body: formData
                });
                const result = await response.json();

                db[curMod][curItem].files.push({ id: Date.now(), name, date, url: result.webViewLink, type, ts: new Date(date).getTime() });
                save(); renderFiles();
                document.getElementById('upload-msg').innerText = "âœ… àª¸àª«àª³àª¤àª¾àªªà«‚àª°à«àªµàª• àª‰àª®à«‡àª°àª¾àª¯à«àª‚!";
                fileInput.value = ''; document.getElementById('fName').value = '';
            } catch (err) {
                alert("àª­à«‚àª²: àªªàª¹à«‡àª²àª¾ Google Drive àª¸àª¾àª¥à«‡ àªœà«‹àª¡à«‹.");
                document.getElementById('upload-msg').innerText = "";
            }
        }

        // Basic Functions
        function save() { localStorage.setItem('StampAct_V22', JSON.stringify(db)); }
        function openModule(m) { curMod = m; document.getElementById('home-view').style.display='none'; document.getElementById('app-view').style.display='flex'; refreshSide(); selectItem(Object.keys(db[curMod])[0] || ""); }
        function goHome() { document.getElementById('home-view').style.display='flex'; document.getElementById('app-view').style.display='none'; }

        function refreshSide() {
            const list = document.getElementById('item-list');
            list.innerHTML = "";
            Object.keys(db[curMod]).forEach(k => {
                const li = document.createElement('li');
                li.innerText = k;
                li.onclick = () => selectItem(k);
                if(k === curItem) li.className = 'active';
                list.appendChild(li);
            });
        }

        function selectItem(n) {
            curItem = n;
            document.getElementById('current-name').innerText = n;
            document.getElementById('p-text').innerText = db[curMod][curItem]?.provision || "...";
            renderFiles(); refreshSide();
        }

        function renderFiles() {
            const container = document.getElementById('results-area');
            container.innerHTML = "";
            const files = db[curMod][curItem]?.files || [];
            files.forEach(f => {
                container.innerHTML += `<div class="card"><strong>${f.type}</strong>: <a href="${f.url}" target="_blank">${f.name}</a> (${f.date})</div>`;
            });
        }

        window.onload = () => { gapiLoaded(); gisLoaded(); };
    </script>
</body>
</html>
